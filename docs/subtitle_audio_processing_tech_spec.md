# Техническое задание: Обработка внешних файлов субтитров и аудио в торрент-сериалах

## Введение

В проекте series-tracker требуется реализовать функциональность для обработки торрентов, содержащих внешние файлы субтитров и аудио дорожек. В отличие от встроенных субтитров и аудио видеофайлах, внешние файлы требуют отдельной обработки и сопоставления с соответствующими сериями.

## Текущая проблема

Существующая архитектура обрабатывает только видеофайлы, игнорируя внешние субтитры и аудио дорожки. При наличии структуры:

```
./Boku.no.S8.WEB-DL.1080p/RUS Sound/AniLiberty/[BudLightSubs] Boku no S8 - 01 [1080p].mka
./Boku.no.S8.WEB-DL.1080p/RUS Sound/JAM Club/[BudLightSubs] Boku no S8 - 01 [1080p].mka
./Boku.no.S8.WEB-DL.1080p/RUS Sound/TVShows/[BudLightSubs] Boku no S8 - 01 [1080p].mk
./Boku.no.S8.WEB-DL.1080p/RUS Subs/teste[BudLightSubs] Boku no S8 - 01 [1080p].ass
./Boku.no.S8.WEB-DL.1080p/[BudLightSubs] Boku no S8 - 01 [1080p].mkv
```

Система обрабатывает только видеофайл `.mkv`, игнорируя внешние `.mka` и `.ass` файлы.

## Цель

Разработать и реализовать модуль, который:
- Обнаруживает внешние файлы субтитров и аудио в торрентах
- Извлекает из них дополнительные метаданные (студия озвучки, тип субтитров)
- Переименовывает и распределяет их по сезонам в соответствии с шаблоном
- Сохраняет совместимость с существующей архитектурой

## Требования

### Функциональные требования

1. **Обнаружение внешних файлов**
   - Система должна распознавать файлы субтитров по расширениям: `.ass`, `.srt`, `.ssa`, `.sub`
   - Система должна распознавать аудио дорожки по расширениям: `.mka`, `.aac`, `.ac3`, `.dts`
   - Обработка должна происходить на уровне торрента, через API qBittorrent

2. **Извлечение метаданных**
   - Использовать существующий `rule_engine` для извлечения базовых метаданных (сезон, серия, качество)
   - Для внешних файлов использовать специализированные профили: "[audio]" и "[subtitle]"
   - Извлечение дополнительной информации из пути к файлу (студия озвучки, тип субтитров)

3. **Специальные переменные в rule_engine**
   - Для аудио: `[audio_name=название_озвучки]`, `[audio_lang=ru]`, `[audio_default]` (опционально)
   - Для субтитров: `[subtitle_name=название_субтитров]`, `[subtitle_lang=ru]`, `[subtitle_default]` (опционально), `[subtitle_forced]` (опционально)
   - Обязательные параметры: `[subtitle_name=...]`, `[subtitle_lang=...]` для субтитров и `[audio_name=...]`, `[audio_lang=...]` для аудио

4. **Формат итоговых имен файлов**
   - Видео: `Series Name SXXEYY [quality] [resolution].mkv`
   - Аудио: `Series Name SXXEYY [quality] [resolution].[lang].[audio_name].[default].ext`
   - Субтитры: `Series Name SXXEYY [quality] [resolution].[lang].[subtitle_name].[default|forced].ext`

5. **Распределение по сезонам**
   - Создание папок в формате `Season XX` (или `season XX`)
   - Распределение всех файлов (видео, аудио, субтитры) в соответствующие папки сезонов

### Нефункциональные требования

1. **Совместимость**
   - Все существующие правила в `rule_engine` должны продолжать работать без изменений
   - Не требуется пересоздание базы данных
   - Модификации `rule_engine` должны быть обратно совместимыми

2. **Производительность**
   - Обработка не должна значительно замедлять основной процесс переименования
   - Поддержка больших торрентов с множеством внешних файлов

3. **Надежность**
   - Обработка должна быть устойчивой к отсутствующим файлам
   - Должна быть реализована надежная логика сопоставления внешних файлов с видео

## Пример обработки

### Входные данные:
```
./Boku.no.S8.WEB-DL.1080p/RUS Sound/AniLiberty/[BudLightSubs] Boku no S8 - 01 [1080p].mka
./Boku.no.S8.WEB-DL.1080p/RUS Sound/JAM Club/[BudLightSubs] Boku no S8 - 01 [1080p].mka
./Boku.no.S8.WEB-DL.1080p/RUS Sound/TVShows/[BudLightSubs] Boku no S8 - 01 [1080p].mk
./Boku.no.S8.WEB-DL.1080p/RUS Subs/teste[BudLightSubs] Boku no S8 - 01 [1080p].ass
./Boku.no.S8.WEB-DL.1080p/[BudLightSubs] Boku no S8 - 01 [1080p].mkv
```

### Ожидаемый результат:
```
./Season 08/Boku no S08E01 [WEB-DL] [1080p].mkv
./Season 08/Boku no S08E01 [WEB-DL] [1080p].ru.AniLiberty.mka
./Season 08/Boku no S08E01 [WEB-DL] [1080p].ru.JAM_Club.default.mka
./Season 08/Boku no S08E01 [WEB-DL] [1080p].ru.TVShows.mka
./Season 08/Boku no S08E01 [WEB-DL] [1080p].ru.teste.ass
```

## Архитектурные изменения

### Новый модуль: `logic/subtitle_audio_processor.py`
- Центральный компонент для обработки внешних файлов
- Использует существующие компоненты: `RuleEngine`, `FilenameFormatter`, `QBittorrentClient`
- Интегрируется с `RenamingAgent`

### Модификация `logic/renaming_processor.py`
- Расширение функции `process_and_rename_torrent_files` для обработки внешних файлов
- Логика распознавания типов файлов и направления в соответствующие профили

### Модификация `rule_engine.py`
- Обеспечение обратной совместимости
- Поддержка специальных переменных в квадратных скобках
- Возможность создания специализированных профилей "[audio]" и "[subtitle]"

### Модификация `filename_formatter.py`
- Поддержка новых форматов имен файлов с учетом специальных переменных
- Формирование имен с языковыми и типовыми метками

## Порядок реализации

1. **Подготовительный этап**
   - Анализ текущей архитектуры
   - Подготовка специальных профилей "[audio]" и "[subtitle]"

2. **Разработка основного модуля**
   - Создание `logic/subtitle_audio_processor.py`
   - Реализация логики сопоставления файлов

3. **Интеграция с существующими компонентами**
   - Модификация `renaming_processor.py`
   - Обновление `rule_engine.py` с сохранением совместимости
   - Обновление `filename_formatter.py`

4. **Тестирование**
   - Проверка работы с различными форматами файлов
   - Проверка обратной совместимости
   - Тестирование с реальными торрентами

## Особенности реализации

### Совместимость существующими правилами
- Все изменения в `rule_engine.py` должны быть обратно совместимы
- Существующие профили не должны требовать пересоздания
- База данных не должна требовать пересоздания

### Управление специальными переменными
- Специальные переменные в квадратных скобках будут добавляться вручную
- Система должна корректно обрабатывать как обычные, так и специальные переменные
- Необходима валидация синтаксиса специальных переменных

### Обработка различных форматов
- Поддержка различных форматов субтитров: ASS, SRT, SSA, SUB
- Поддержка различных форматов аудио: MKA, AAC, AC3, DTS
- Гибкое сопоставление по метаданным (сезон, серия, качество)

## Ожидаемый результат

После реализации система будет:
- Автоматически обнаруживать внешние файлы субтитров и аудио в торрентах
- Извлекать из них дополнительные метаданные с помощью специализированных профилей
- Переименовывать и распределять все файлы по сезонам в соответствии с заданным форматом
- Сохранять полную обратную совместимость с существующими правилами и базой данных